# 1. Images (REQUIRED: This tells Lima what to download)
images:
  - location: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-arm64.img"
    arch: "aarch64"

# 2. Virtualization Engine
vmType: "vz"
mountType: "virtiofs"

# --- Shared Folders ---
# This links your Mac folders to the VM
mounts:
  - location: "~"        # Your Mac Home folder
    writable: true
  - location: "/tmp/lima" # A shared temp space
    writable: true

# 3. Resources: specify in the limactl start command
#cpus: 4
#memory: "6GiB"

# 4. Rosetta 2 (for Apple Silicon)
vmOpts:
  vz:
    rosetta:
      enabled: true
      binfmt: true

# 5. Networking
#networks:
#  - vzNAT: false

# 6. Automated K3s Installation
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -e

      # --- A. Ubuntu 24.04 Security Patch ---
      # Fix for unprivileged user namespaces (required for BuildKit/K3s)
      sysctl -w kernel.apparmor_restrict_unprivileged_userns=0
      echo "kernel.apparmor_restrict_unprivileged_userns=0" > /etc/sysctl.d/99-userns.conf

      # --- B. Install BuildKit ---
      if [ ! -f /usr/local/bin/buildkitd ]; then
        echo "Downloading BuildKit..."
        # We use the latest stable version for arm64
        BK_VERSION="v0.19.0"
        curl -sSL "https://github.com/moby/buildkit/releases/download/${BK_VERSION}/buildkit-${BK_VERSION}.linux-arm64.tar.gz" -o /tmp/buildkit.tar.gz
        tar -C /usr/local -xzf /tmp/buildkit.tar.gz
        rm /tmp/buildkit.tar.gz
      fi

      # --- C. Create BuildKit Systemd Service ---
      # This links BuildKit directly to the K3s containerd socket
      cat <<EOF > /etc/systemd/system/buildkit.service
      [Unit]
      Description=BuildKit
      After=network.target k3s.service
      Requires=k3s.service

      [Service]
      ExecStart=/usr/local/bin/buildkitd --containerd-worker-addr /run/k3s/containerd/containerd.sock
      Restart=always

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl daemon-reload
      systemctl enable buildkit

      # --- D. Install K3s ---
      if [ ! -f /usr/local/bin/k3s ]; then
        echo "Installing K3s..."
        curl -sfL https://get.k3s.io | sh -s - server \
          --disable traefik \
          --write-kubeconfig-mode 644
      fi

      # --- E. Start BuildKit ---
      systemctl start buildkit

      # --- F. Configure nerdctl default socket ---
      mkdir -p /etc/nerdctl
      cat <<EOF > /etc/nerdctl/nerdctl.yaml
      address: "unix:///run/k3s/containerd/containerd.sock"
      namespace: "k8s.io"
      EOF

# 7. Port Forwarding for K8s API
portForwards:
  - guestPort: 6443
    hostPort: 6443
  - guestPort: 80
    hostPort: 80
    # Use 0.0.0.0 if you want it accessible to other devices on your LAN
    hostIP: "127.0.0.1"

user:
  name: "ldev"

# Disable the host's problematic DNS and use clean ones
hostResolver:
  enabled: true

#dns:
#  - 8.8.8.8
#  - 1.1.1.1
